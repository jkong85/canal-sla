//bandwidth control interface for EyeQ
//author: Yan Sun

package main

import (
	//"os"
	"encoding/json"
	//"io/ioutil"
	"fmt"
	"github.com/coreos/etcd/client"
	"github.com/docker/libkv"
	"github.com/docker/libkv/store"
	"github.com/docker/libkv/store/etcd"
	"golang.org/x/net/context"
	"log"
	"net"
	"time"
)

type ContainerBW struct {
	NodeIP          string
	PodID           string
	VlanID          string
	VxlanID         string
	PodIP           string
	Action          string
	InBandWidthMin  string // unit is Mbps
	InBandWidthMax  string // unit is Mbps
	OutBandWidthMin string // unit is Mbps
	OutBandWidthMax string // unit is Mbps
	PodPriority     string // 0-7, 0 is the highest priority, 7 is the lowest priority.
}

func check(e error) {
	if e != nil {
		panic(e)
	}
}

/*
func SaveAsJson(bw []ContainerBW, path string) {
	b, err := json.Marshal(bw)
	check(err)
	ioutil.WriteFile(path, b, 0644)
}
*/
func main() {

	l, err := net.Interfaces()
	if err != nil {
		println(err)

	}
	for _, f := range l {
		fmt.Println(f.Index, f.Name)
	}

	bw := []ContainerBW{
		{"192.0.0.1", "1", "100", "1", "all", "add", "100", "100", "100", "100", "0"},
		{"192.0.0.1", "1", "100", "1", "default", "add", "10", "100", "10", "100", "7"},
		{"192.0.0.1", "1", "100", "1", "10.1.2.2", "add", "500", "500", "700", "700", "0"},
		{"192.0.0.2", "2", "102", "2", "10.1.2.3", "add", "200", "200", "200", "200", "5"},
		{"192.0.0.2", "2", "102", "2", "10.1.2.4", "add", "200", "200", "200", "200", "7"},
		{"192.0.0.1", "1", "100", "1", "10.1.2.5", "add", "20", "100", "20", "100", "0"},
		{"192.0.0.1", "1", "100", "1", "10.1.2.6", "add", "10", "100", "10", "100", "5"},
		{"192.0.0.1", "1", "100", "1", "10.1.2.7", "add", "20", "100", "20", "100", "5"},
		{"192.0.0.2", "2", "102", "2", "10.1.2.8", "add", "20", "100", "20", "100", "7"},
		{"192.0.0.2", "2", "102", "2", "10.1.2.9", "add", "200", "200", "200", "200", "7"},
		{"192.0.0.1", "1", "100", "1", "10.1.2.10", "add", "1000", "1000", "1000", "1000", "0"},
		{"192.0.0.1", "1", "100", "1", "10.1.2.11", "add", "10", "100", "10", "100", "5"},
		{"192.0.0.1", "1", "100", "1", "10.1.2.12", "add", "500", "500", "700", "700", "0"},
		{"192.0.0.2", "2", "102", "2", "10.1.2.13", "add", "200", "200", "200", "200", "5"},
		{"192.0.0.2", "2", "102", "2", "10.1.2.14", "add", "200", "200", "200", "200", "7"},
		{"192.0.0.1", "1", "100", "1", "10.1.2.15", "add", "1000", "1000", "1000", "1000", "0"},
		{"192.0.0.1", "1", "100", "1", "10.1.2.16", "add", "10", "100", "10", "100", "5"},
		{"192.0.0.1", "1", "100", "1", "10.1.2.17", "add", "500", "500", "700", "700", "0"},
		{"192.0.0.2", "2", "102", "2", "10.1.2.18", "add", "200", "200", "200", "200", "5"},
		{"192.0.0.2", "2", "102", "2", "10.1.2.19", "add", "200", "200", "200", "200", "7"},
		{"192.0.0.1", "1", "100", "1", "10.1.2.20", "add", "1000", "1000", "1000", "1000", "0"},
		{"192.0.0.1", "1", "100", "1", "10.1.2.21", "add", "10", "100", "10", "100", "5"},
		{"192.0.0.1", "1", "100", "1", "10.1.2.22", "add", "500", "500", "700", "700", "0"},
		{"192.0.0.2", "2", "102", "2", "10.1.2.23", "add", "200", "200", "200", "200", "5"},
		{"192.0.0.2", "2", "102", "2", "10.1.2.24", "add", "200", "200", "200", "200", "7"},
		{"192.0.0.1", "1", "100", "1", "10.1.2.25", "add", "1000", "1000", "1000", "1000", "0"},
		{"192.0.0.1", "1", "100", "1", "10.1.2.26", "add", "10", "100", "10", "100", "5"},
		{"192.0.0.1", "1", "100", "1", "10.1.2.27", "add", "500", "500", "700", "700", "0"},
		{"192.0.0.2", "2", "102", "2", "10.1.2.28", "add", "200", "200", "200", "200", "5"},
		{"192.0.0.2", "2", "102", "2", "10.1.2.29", "add", "200", "200", "200", "200", "7"},
		{"192.0.0.1", "1", "100", "1", "10.1.2.30", "add", "1000", "1000", "1000", "1000", "0"},
		{"192.0.0.1", "1", "100", "1", "10.1.2.31", "add", "10", "100", "10", "100", "5"},
		{"192.0.0.1", "1", "100", "1", "10.1.2.32", "add", "500", "500", "700", "700", "0"},
		{"192.0.0.2", "2", "102", "2", "10.1.2.33", "add", "200", "200", "200", "200", "5"},
		{"192.0.0.2", "2", "102", "2", "10.1.2.34", "add", "200", "200", "200", "200", "7"},
		{"192.0.0.1", "1", "100", "1", "10.1.2.35", "add", "1000", "1000", "1000", "1000", "0"},
		{"192.0.0.1", "1", "100", "1", "10.1.2.36", "add", "10", "100", "10", "100", "5"},
		{"192.0.0.1", "1", "100", "1", "10.1.2.37", "add", "500", "500", "700", "700", "0"},
		{"192.0.0.2", "2", "102", "2", "10.1.2.38", "add", "200", "200", "200", "200", "5"},
		{"192.0.0.2", "2", "102", "2", "10.1.2.39", "add", "200", "200", "200", "200", "7"},
		{"192.0.0.1", "1", "100", "1", "10.1.2.40", "add", "1000", "1000", "1000", "1000", "0"},
		{"192.0.0.1", "1", "100", "1", "10.1.2.41", "add", "10", "100", "10", "100", "5"},
		{"192.0.0.1", "1", "100", "1", "10.1.2.42", "add", "500", "500", "700", "700", "0"},
		{"192.0.0.2", "2", "102", "2", "10.1.2.43", "add", "200", "200", "200", "200", "5"},
		{"192.0.0.2", "2", "102", "2", "10.1.2.44", "add", "200", "200", "200", "200", "7"},
		{"192.0.0.1", "1", "100", "1", "10.1.2.45", "add", "1000", "1000", "1000", "1000", "0"},
		{"192.0.0.1", "1", "100", "1", "10.1.2.46", "add", "10", "100", "10", "100", "5"},
		{"192.0.0.1", "1", "100", "1", "10.1.2.47", "add", "500", "500", "700", "700", "0"},
		{"192.0.0.2", "2", "102", "2", "10.1.2.48", "add", "200", "200", "200", "200", "5"},
		{"192.0.0.2", "2", "102", "2", "10.1.2.49", "add", "200", "200", "200", "200", "7"},
		{"192.0.0.1", "1", "100", "1", "10.1.2.50", "add", "1000", "1000", "1000", "1000", "0"},
		{"192.0.0.1", "1", "100", "1", "10.1.2.51", "add", "10", "100", "10", "100", "5"},
		{"192.0.0.1", "1", "100", "1", "10.1.2.52", "add", "500", "500", "700", "700", "0"},
		{"192.0.0.2", "2", "102", "2", "10.1.2.53", "add", "200", "200", "200", "200", "5"},
		{"192.0.0.2", "2", "102", "2", "10.1.2.54", "add", "200", "200", "200", "200", "7"},
		{"192.0.0.1", "1", "100", "1", "10.1.2.55", "add", "1000", "1000", "1000", "1000", "0"},
		{"192.0.0.1", "1", "100", "1", "10.1.2.56", "add", "10", "100", "10", "100", "5"},
		{"192.0.0.1", "1", "100", "1", "10.1.2.57", "add", "500", "500", "700", "700", "0"},
		{"192.0.0.2", "2", "102", "2", "10.1.2.58", "add", "200", "200", "200", "200", "5"},
		{"192.0.0.2", "2", "102", "2", "10.1.2.59", "add", "200", "200", "200", "200", "7"},
		{"192.0.0.1", "1", "100", "1", "10.1.2.60", "add", "1000", "1000", "1000", "1000", "0"},
		{"192.0.0.1", "1", "100", "1", "10.1.2.61", "add", "10", "100", "10", "100", "5"},
		{"192.0.0.1", "1", "100", "1", "10.1.2.62", "add", "500", "500", "700", "700", "0"},
		{"192.0.0.2", "2", "102", "2", "10.1.2.63", "add", "200", "200", "200", "200", "5"},
		{"192.0.0.2", "2", "102", "2", "10.1.2.64", "add", "200", "200", "200", "200", "7"},
		{"192.0.0.1", "1", "100", "1", "10.1.2.65", "add", "1000", "1000", "1000", "1000", "0"},
		{"192.0.0.1", "1", "100", "1", "10.1.2.66", "add", "10", "100", "10", "100", "5"},
		{"192.0.0.1", "1", "100", "1", "10.1.2.67", "add", "500", "500", "700", "700", "0"},
		{"192.0.0.2", "2", "102", "2", "10.1.2.68", "add", "200", "200", "200", "200", "5"},
		{"192.0.0.2", "2", "102", "2", "10.1.2.69", "add", "200", "200", "200", "200", "7"},
		{"192.0.0.1", "1", "100", "1", "10.1.2.70", "add", "1000", "1000", "1000", "1000", "0"},
		{"192.0.0.1", "1", "100", "1", "10.1.2.71", "add", "10", "100", "10", "100", "5"},
		{"192.0.0.1", "1", "100", "1", "10.1.2.72", "add", "500", "500", "700", "700", "0"},
		{"192.0.0.2", "2", "102", "2", "10.1.2.73", "add", "200", "200", "200", "200", "5"},
		{"192.0.0.2", "2", "102", "2", "10.1.2.74", "add", "200", "200", "200", "200", "7"},
		{"192.0.0.1", "1", "100", "1", "10.1.2.75", "add", "1000", "1000", "1000", "1000", "0"},
		{"192.0.0.1", "1", "100", "1", "10.1.2.76", "add", "10", "100", "10", "100", "5"},
		{"192.0.0.1", "1", "100", "1", "10.1.2.77", "add", "500", "500", "700", "700", "0"},
		{"192.0.0.2", "2", "102", "2", "10.1.2.78", "add", "200", "200", "200", "200", "5"},
		{"192.0.0.2", "2", "102", "2", "10.1.2.79", "add", "200", "200", "200", "200", "7"},
		{"192.0.0.1", "1", "100", "1", "10.1.2.80", "add", "1000", "1000", "1000", "1000", "0"},
		{"192.0.0.1", "1", "100", "1", "10.1.2.81", "add", "10", "100", "10", "100", "5"},
		{"192.0.0.1", "1", "100", "1", "10.1.2.82", "add", "500", "500", "700", "700", "0"},
		{"192.0.0.2", "2", "102", "2", "10.1.2.83", "add", "200", "200", "200", "200", "5"},
		{"192.0.0.2", "2", "102", "2", "10.1.2.84", "add", "200", "200", "200", "200", "7"},
		{"192.0.0.1", "1", "100", "1", "10.1.2.85", "add", "1000", "1000", "1000", "1000", "0"},
		{"192.0.0.1", "1", "100", "1", "10.1.2.86", "add", "10", "100", "10", "100", "5"},
		{"192.0.0.1", "1", "100", "1", "10.1.2.87", "add", "500", "500", "700", "700", "0"},
		{"192.0.0.2", "2", "102", "2", "10.1.2.88", "add", "200", "200", "200", "200", "5"},
		{"192.0.0.2", "2", "102", "2", "10.1.2.89", "add", "200", "200", "200", "200", "7"},
		{"192.0.0.1", "1", "100", "1", "10.1.2.90", "add", "1000", "1000", "1000", "1000", "0"},
		{"192.0.0.1", "1", "100", "1", "10.1.2.91", "add", "10", "100", "10", "100", "5"},
		{"192.0.0.1", "1", "100", "1", "10.1.2.92", "add", "500", "500", "700", "700", "0"},
		{"192.0.0.2", "2", "102", "2", "10.1.2.93", "add", "200", "200", "200", "200", "5"},
		{"192.0.0.2", "2", "102", "2", "10.1.2.94", "add", "200", "200", "200", "200", "7"},
		{"192.0.0.1", "1", "100", "1", "10.1.2.95", "add", "1000", "1000", "1000", "1000", "0"},
		{"192.0.0.1", "1", "100", "1", "10.1.2.96", "add", "10", "100", "10", "100", "5"},
		{"192.0.0.1", "1", "100", "1", "10.1.2.97", "add", "500", "500", "700", "700", "0"},
		{"192.0.0.2", "2", "102", "2", "10.1.2.98", "add", "200", "200", "200", "200", "5"},
		{"192.0.0.2", "2", "102", "2", "10.1.2.99", "add", "200", "200", "200", "200", "7"},
		{"192.0.0.1", "1", "100", "1", "10.1.2.100", "add", "1000", "1000", "1000", "1000", "0"},
	}

	// We can register as many backends that are supported by libkv
	etcd.Register()

	server := "127.0.0.1:4001"

	// Initialize a new store with consul
	kv, err := libkv.NewStore(
		store.ETCD,
		[]string{server},
		&store.Config{
			ConnectionTimeout: 10 * time.Second,
		},
	)
	if err != nil {
		log.Fatal("Cannot create store", kv)
	}

	cfg := client.Config{
		Endpoints: []string{"http://127.0.0.1:4001"},
		Transport: client.DefaultTransport,
		//set timeout per request to fail fast when the target endpoint is unavailable
		HeaderTimeoutPerRequest: time.Second,
	}

	c, err := client.New(cfg)
	if err != nil {
		log.Fatal(err)
	}

	kapi := client.NewKeysAPI(c)

	qos_encode, err := json.Marshal(bw)
	if err != nil {
		log.Fatal(err)
	}

	intf, err := net.InterfaceByName("ens3")

	if err != nil {
		log.Fatal("Cannot find interface by name eth0")
	}

	mac := intf.HardwareAddr

	key := "/" + fmt.Sprintf("%x", mac)

	resp, err := kapi.Set(context.Background(), key, string(qos_encode), nil)
	if err != nil {
		log.Fatal(err)
	} else {
		//log.Printf("Set is done. Metadata is %q\n", resp)
		fmt.Println("Set is done. Metadata is %q\n", resp)
	}

	/*
		path := "./qos.json"
		f, err := os.Create(path)
		check(err)

		defer f.Close()
		SaveAsJson(bw, path)
		f.Sync()
	*/
}
